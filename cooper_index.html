<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Cooper</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        .tab-active { background: #3b82f6; color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
        .status-good { background: #d1fae5; color: #065f46; }
        .status-ok { background: #fef3c7; color: #92400e; }
        .status-bad { background: #fee2e2; color: #991b1b; }
        .carnet-badge { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>
    <div id="root"></div>
 
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const YEARS = ['2024', '2025', '2026', '2027'];
        
        // ‚ö†Ô∏è CONFIGURA QUESTI VALORI
        const SHEET_ID = 'INSERISCI_SHEET_ID';
        const SCRIPT_URL = 'INSERISCI_SCRIPT_URL';
        
        function App() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [showPassword, setShowPassword] = useState(false);
          const [savedPassword, setSavedPassword] = useState('');
          const [activeTab, setActiveTab] = useState('dashboard');
          const [isLoading, setIsLoading] = useState(false);
          
          // Dati
          const [invoices, setInvoices] = useState([]);
          const [carnet, setCarnet] = useState([]);
          const [creditNotes, setCreditNotes] = useState([]);
          const [products, setProducts] = useState({});
          
          const PRODUCTS = Object.keys(products).sort();
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
          const [searchQuery, setSearchQuery] = useState('');
          
          // Form fattura
          const [invoiceDate, setInvoiceDate] = useState(new Date().toISOString().split('T')[0]);
          const [invoiceNumber, setInvoiceNumber] = useState('');
          const [invoiceItems, setInvoiceItems] = useState([{ product: '', quantity: '', price: '', discount: '10', vat: '4' }]);
          const [editingInvoice, setEditingInvoice] = useState(null);
          
          // Form carnet
          const [carnetDate, setCarnetDate] = useState(new Date().toISOString().split('T')[0]);
          const [carnetNumber, setCarnetNumber] = useState('');
          const [carnetItems, setCarnetItems] = useState([{ product: '', quantity: '', priceUnit: '', vat: '4' }]);
          const [editingCarnet, setEditingCarnet] = useState(null);
          
          // Form nota credito
          const [creditDate, setCreditDate] = useState(new Date().toISOString().split('T')[0]);
          const [creditProduct, setCreditProduct] = useState('');
          const [creditQuantity, setCreditQuantity] = useState('');
          const [creditPriceUnit, setCreditPriceUnit] = useState('');
          const [creditVat, setCreditVat] = useState('4');
          const [editingCredit, setEditingCredit] = useState(null);
          
          // Form prodotto
          const [editingProduct, setEditingProduct] = useState(null);
          const [newProductName, setNewProductName] = useState('');
          const [newProductPrice, setNewProductPrice] = useState('');
          const [newProductCarnet, setNewProductCarnet] = useState(false);
          const [productListSearch, setProductListSearch] = useState('');
          
          // Modali
          const [modal, setModal] = useState({ show: false, type: '', title: '', message: '' });
          const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: null });
          
          // Dropdown
          const [productDropdownOpen, setProductDropdownOpen] = useState({});
          const [productSearchQuery, setProductSearchQuery] = useState({});
          const productInputRefs = useRef({});
          
          useEffect(() => {
            const stored = localStorage.getItem('cooperAppPassword');
            if (stored) {
              setSavedPassword(stored);
              setIsAuthenticated(true);
              loadFromGoogleSheets(stored);
            }
          }, []);
          
          const loadFromGoogleSheets = async (pwd = savedPassword) => {
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL);
              if (!response.ok) throw new Error(`Errore server: ${response.status}`);
              const data = await response.json();
              
              // Raggruppa fatture per ID
              const invoiceMap = {};
              (data.invoices || []).forEach(row => {
                if (!invoiceMap[row.id]) {
                  invoiceMap[row.id] = {
                    id: row.id, year: row.year, date: row.date, number: row.number,
                    shippingCost: row.shippingCost || 0, items: []
                  };
                }
                invoiceMap[row.id].items.push({
                  product: row.product, quantity: row.quantity, priceGross: row.priceGross,
                  discount: row.discount, vat: row.vat, priceNet: row.priceNet
                });
              });
              setInvoices(Object.values(invoiceMap));
              
              // Raggruppa carnet per ID
              const carnetMap = {};
              (data.carnet || []).forEach(row => {
                if (!carnetMap[row.id]) {
                  carnetMap[row.id] = {
                    id: row.id, year: row.year, date: row.date, number: row.number, items: []
                  };
                }
                carnetMap[row.id].items.push({
                  product: row.product, quantity: row.quantity, priceUnit: row.priceUnit,
                  vat: row.vat, total: row.total
                });
              });
              setCarnet(Object.values(carnetMap));
              
              setCreditNotes(data.creditNotes || []);
              setProducts(data.products || {});
            } catch (error) {
              console.error('Errore caricamento:', error);
              setModal({ show: true, type: 'error', title: 'Errore caricamento', message: error.message });
            }
            setIsLoading(false);
          };
          
          const saveToGoogleSheets = async (action, payload, skipReload = false) => {
            if (!savedPassword) return false;
            setIsLoading(true);
            try {
              await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ password: savedPassword, action, ...payload }),
                mode: 'no-cors'
              });
              await new Promise(r => setTimeout(r, 1500));
              if (!skipReload) await loadFromGoogleSheets();
              else setIsLoading(false);
              return true;
            } catch (error) {
              setModal({ show: true, type: 'error', title: 'Errore salvataggio', message: error.message });
              setIsLoading(false);
              return false;
            }
          };
          
          const handleLogin = async () => {
            if (!password) return setModal({ show: true, type: 'warning', title: 'Password richiesta', message: 'Inserisci la password.' });
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ password: password, action: 'testPassword' })
              });
              const result = await response.json();
              if (result.success === false) {
                setIsLoading(false);
                return setModal({ show: true, type: 'error', title: 'Password errata', message: 'La password non √® corretta.' });
              }
              localStorage.setItem('cooperAppPassword', password);
              setSavedPassword(password);
              setIsAuthenticated(true);
              await loadFromGoogleSheets(password);
            } catch (error) {
              setIsLoading(false);
              setModal({ show: true, type: 'error', title: 'Errore login', message: 'Impossibile verificare la password.' });
            }
          };
          
          const handleLogout = () => {
            localStorage.removeItem('cooperAppPassword');
            setSavedPassword('');
            setIsAuthenticated(false);
            setPassword('');
            setInvoices([]);
            setCarnet([]);
            setCreditNotes([]);
            setProducts({});
          };
          
          // ==================== FATTURE ====================
          const addInvoiceItem = () => setInvoiceItems([...invoiceItems, { product: '', quantity: '', price: '', discount: '10', vat: '4' }]);
          const removeInvoiceItem = i => setInvoiceItems(invoiceItems.filter((_, idx) => idx !== i));
          const updateInvoiceItem = (i, field, value) => {
            const updated = [...invoiceItems];
            updated[i][field] = value;
            setInvoiceItems(updated);
          };
          
          const resetInvoiceForm = () => {
            setEditingInvoice(null);
            setInvoiceDate(new Date().toISOString().split('T')[0]);
            setInvoiceNumber('');
            setInvoiceItems([{ product: '', quantity: '', price: '', discount: '10', vat: '4' }]);
          };
          
          const saveInvoice = async () => {
            const validItems = invoiceItems.filter(i => i.product && i.quantity && i.price);
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) {
              return setModal({ show: true, type: 'warning', title: 'Campi obbligatori', message: 'Compila data, numero e almeno un prodotto.' });
            }
            const year = new Date(invoiceDate).getFullYear().toString();
            const payload = {
              id: editingInvoice ? editingInvoice.id : Date.now(),
              date: invoiceDate, number: invoiceNumber, year: year, shippingCost: 0,
              items: validItems.map(item => ({
                product: item.product,
                quantity: parseFloat(item.quantity),
                priceGross: parseFloat(item.price),
                discount: parseFloat(item.discount) || 0,
                vat: parseFloat(item.vat) || 4,
                priceNet: parseFloat(item.price) * (1 - (parseFloat(item.discount) || 0) / 100)
              }))
            };
            const action = editingInvoice ? 'updateInvoice' : 'saveInvoice';
            const success = await saveToGoogleSheets(action, payload);
            if (success) {
              resetInvoiceForm();
              setModal({ show: true, type: 'success', title: 'Salvato', message: 'Fattura salvata con successo!' });
            }
          };
          
          const deleteInvoice = (id) => {
            setConfirmModal({
              show: true, title: 'Elimina fattura', message: 'Sei sicuro?',
              onConfirm: async () => {
                setConfirmModal({ show: false });
                await saveToGoogleSheets('deleteInvoice', { id });
              }
            });
          };
          
          const startEditInvoice = (inv) => {
            setEditingInvoice(inv);
            setInvoiceDate(inv.date);
            setInvoiceNumber(inv.number);
            setInvoiceItems(inv.items.map(item => ({
              product: item.product, quantity: item.quantity, price: item.priceGross,
              discount: item.discount || '10', vat: item.vat || '4'
            })));
            setActiveTab('invoices');
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          
          // ==================== CARNET ====================
          const addCarnetItem = () => setCarnetItems([...carnetItems, { product: '', quantity: '', priceUnit: '', vat: '4' }]);
          const removeCarnetItem = i => setCarnetItems(carnetItems.filter((_, idx) => idx !== i));
          const updateCarnetItem = (i, field, value) => {
            const updated = [...carnetItems];
            updated[i][field] = value;
            setCarnetItems(updated);
          };
          
          const resetCarnetForm = () => {
            setEditingCarnet(null);
            setCarnetDate(new Date().toISOString().split('T')[0]);
            setCarnetNumber('');
            setCarnetItems([{ product: '', quantity: '', priceUnit: '', vat: '4' }]);
          };
          
          const saveCarnet = async () => {
            const validItems = carnetItems.filter(i => i.product && i.quantity && i.priceUnit);
            if (!carnetDate || !carnetNumber || validItems.length === 0) {
              return setModal({ show: true, type: 'warning', title: 'Campi obbligatori', message: 'Compila data, numero e almeno un prodotto.' });
            }
            const year = new Date(carnetDate).getFullYear().toString();
            const payload = {
              id: editingCarnet ? editingCarnet.id : Date.now(),
              date: carnetDate, number: carnetNumber, year: year,
              items: validItems.map(item => ({
                product: item.product,
                quantity: parseFloat(item.quantity),
                priceUnit: parseFloat(item.priceUnit),
                vat: parseFloat(item.vat) || 4
              }))
            };
            const action = editingCarnet ? 'updateCarnet' : 'saveCarnet';
            const success = await saveToGoogleSheets(action, payload);
            if (success) {
              resetCarnetForm();
              setModal({ show: true, type: 'success', title: 'Salvato', message: 'Carnet salvato con successo!' });
            }
          };
          
          const deleteCarnet = (id) => {
            setConfirmModal({
              show: true, title: 'Elimina carnet', message: 'Sei sicuro?',
              onConfirm: async () => {
                setConfirmModal({ show: false });
                await saveToGoogleSheets('deleteCarnet', { id });
              }
            });
          };
          
          const startEditCarnet = (c) => {
            setEditingCarnet(c);
            setCarnetDate(c.date);
            setCarnetNumber(c.number);
            setCarnetItems(c.items.map(item => ({
              product: item.product, quantity: item.quantity, priceUnit: item.priceUnit, vat: item.vat || '4'
            })));
            setActiveTab('carnet');
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          
          // ==================== NOTE CREDITO ====================
          const resetCreditForm = () => {
            setEditingCredit(null);
            setCreditDate(new Date().toISOString().split('T')[0]);
            setCreditProduct('');
            setCreditQuantity('');
            setCreditPriceUnit('');
            setCreditVat('4');
          };
          
          const saveCreditNote = async () => {
            if (!creditDate || !creditProduct || !creditQuantity || !creditPriceUnit) {
              return setModal({ show: true, type: 'warning', title: 'Campi obbligatori', message: 'Compila tutti i campi.' });
            }
            const year = new Date(creditDate).getFullYear().toString();
            const payload = {
              id: editingCredit ? editingCredit.id : Date.now(),
              date: creditDate, year: year,
              product: creditProduct,
              quantity: parseFloat(creditQuantity),
              priceUnit: parseFloat(creditPriceUnit),
              vat: parseFloat(creditVat) || 4
            };
            const action = editingCredit ? 'updateCreditNote' : 'saveCreditNote';
            const success = await saveToGoogleSheets(action, payload);
            if (success) {
              resetCreditForm();
              setModal({ show: true, type: 'success', title: 'Salvato', message: 'Nota di credito salvata!' });
            }
          };
          
          const deleteCreditNote = (id) => {
            setConfirmModal({
              show: true, title: 'Elimina nota credito', message: 'Sei sicuro?',
              onConfirm: async () => {
                setConfirmModal({ show: false });
                await saveToGoogleSheets('deleteCreditNote', { id });
              }
            });
          };
          
          const startEditCredit = (note) => {
            setEditingCredit(note);
            setCreditDate(note.date);
            setCreditProduct(note.product);
            setCreditQuantity(note.quantity);
            setCreditPriceUnit(note.priceUnit);
            setCreditVat(note.vat || '4');
            setActiveTab('credits');
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          
          // Chiudi dropdown al click esterno
          useEffect(() => {
            const handleClickOutside = (e) => {
              if (!e.target.closest('.product-dropdown')) setProductDropdownOpen({});
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, []);
          
          // ==================== ANALISI ====================
          const analysis = useMemo(() => {
            const result = {};
            
            PRODUCTS.forEach(product => {
              let totalCost = 0;
              let totalQty = 0;
              
              // Fatture normali (filtrate per anno se selezionato)
              const filteredInvoices = selectedYear === 'all' ? invoices : invoices.filter(i => String(i.year) === selectedYear);
              filteredInvoices.forEach(inv => {
                inv.items.forEach(item => {
                  if (item.product === product) {
                    const qty = parseFloat(item.quantity) || 0;
                    const netPrice = parseFloat(item.priceNet) || 0;
                    const vat = parseFloat(item.vat) || 4;
                    const costWithVat = qty * netPrice * (1 + vat / 100);
                    totalCost += costWithVat;
                    totalQty += qty;
                  }
                });
              });
              
              // Carnet (filtrati per anno)
              const filteredCarnet = selectedYear === 'all' ? carnet : carnet.filter(c => String(c.year) === selectedYear);
              filteredCarnet.forEach(c => {
                c.items.forEach(item => {
                  if (item.product === product) {
                    const qty = parseFloat(item.quantity) || 0;
                    const priceUnit = parseFloat(item.priceUnit) || 0;
                    const vat = parseFloat(item.vat) || 4;
                    const costWithVat = qty * priceUnit * (1 + vat / 100);
                    totalCost += costWithVat;
                    totalQty += qty;
                  }
                });
              });
              
              // Note credito (sottraggono)
              const filteredCredits = selectedYear === 'all' ? creditNotes : creditNotes.filter(n => String(n.year) === selectedYear);
              filteredCredits.forEach(note => {
                if (note.product === product) {
                  const qty = parseFloat(note.quantity) || 0;
                  const priceUnit = parseFloat(note.priceUnit) || 0;
                  const vat = parseFloat(note.vat) || 4;
                  const refund = qty * priceUnit * (1 + vat / 100);
                  totalCost -= refund;
                  totalQty -= qty;
                }
              });
              
              const avgCost = totalQty > 0 ? totalCost / totalQty : 0;
              const onlinePrice = products[product]?.onlinePrice || 0;
              const margin = onlinePrice > 0 ? ((onlinePrice - avgCost) / onlinePrice) * 100 : 0;
              const hasCarnet = products[product]?.hasCarnet || false;
              
              result[product] = { avgCost, onlinePrice, margin, totalQty, totalCost, hasCarnet };
            });
            
            return result;
          }, [invoices, carnet, creditNotes, products, selectedYear]);
          
          // Dropdown prodotti component
          const ProductDropdown = ({ index, value, onChange, prefix = 'inv' }) => {
            const key = `${prefix}-${index}`;
            const inputRef = useRef(null);
            
            return (
              <div className="relative product-dropdown">
                <input
                  ref={inputRef}
                  type="text"
                  value={productSearchQuery[key] || value || ''}
                  onChange={e => {
                    setProductSearchQuery({...productSearchQuery, [key]: e.target.value});
                    setProductDropdownOpen({...productDropdownOpen, [key]: true});
                  }}
                  onFocus={() => setProductDropdownOpen({...productDropdownOpen, [key]: true})}
                  placeholder="Cerca prodotto..."
                  className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                />
                {productDropdownOpen[key] && (
                  <div className="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto">
                    {PRODUCTS.filter(p => p.toLowerCase().includes((productSearchQuery[key] || '').toLowerCase())).map(p => (
                      <div
                        key={p}
                        onClick={() => {
                          onChange(p);
                          setProductSearchQuery({...productSearchQuery, [key]: ''});
                          setProductDropdownOpen({...productDropdownOpen, [key]: false});
                        }}
                        className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm flex justify-between items-center"
                      >
                        <span>{p}</span>
                        {products[p]?.hasCarnet && <span className="text-xs carnet-badge px-2 py-0.5 rounded">CARNET</span>}
                      </div>
                    ))}
                    {PRODUCTS.filter(p => p.toLowerCase().includes((productSearchQuery[key] || '').toLowerCase())).length === 0 && (
                      <div className="px-3 py-2 text-gray-500 text-sm">Nessun prodotto</div>
                    )}
                  </div>
                )}
              </div>
            );
          };
          
          // ==================== LOGIN ====================
          if (!isAuthenticated) {
            return (
              <>
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                  <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                    <h1 className="text-3xl font-bold text-gray-800 mb-2 text-center">Analisi Cooper</h1>
                    <p className="text-gray-500 text-center mb-6">Gestione LAC CooperVision</p>
                    <div className="space-y-4">
                      <div className="relative">
                        <input
                          type={showPassword ? 'text' : 'password'}
                          value={password}
                          onChange={e => setPassword(e.target.value)}
                          onKeyPress={e => e.key === 'Enter' && handleLogin()}
                          placeholder="Inserisci password"
                          className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                        <button onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-gray-500">
                          {showPassword ? 'üôà' : 'üëÅÔ∏è'}
                        </button>
                      </div>
                      <button onClick={handleLogin} disabled={isLoading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50">
                        {isLoading ? 'Accesso...' : 'Accedi'}
                      </button>
                    </div>
                  </div>
                </div>
                {modal.show && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full">
                      <h3 className="text-lg font-bold mb-2">{modal.title}</h3>
                      <p className="text-gray-600 mb-4">{modal.message}</p>
                      <button onClick={() => setModal({ show: false })} className="w-full bg-blue-600 text-white py-2 rounded-lg">OK</button>
                    </div>
                  </div>
                )}
              </>
            );
          }
          
          // ==================== APP PRINCIPALE ====================
          return (
            <div className="min-h-screen bg-gray-50">
              {isLoading && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                  <div className="bg-white rounded-lg p-8 flex items-center gap-4">
                    <div className="animate-spin rounded-full h-10 w-10 border-b-4 border-blue-600"></div>
                    <span className="text-lg">Sincronizzazione...</span>
                  </div>
                </div>
              )}
              
              {/* HEADER */}
              <div className="bg-white shadow">
                <div className="max-w-7xl mx-auto px-4 py-4">
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <div>
                      <h1 className="text-2xl font-bold text-gray-800">Analisi Cooper</h1>
                      <p className="text-sm text-gray-500">Gestione LAC CooperVision</p>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <button onClick={loadFromGoogleSheets} disabled={isLoading} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                        üîÑ Ricarica
                      </button>
                      <a href={`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`} target="_blank" className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                        üìä Sheets
                      </a>
                      <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                        üö™ Logout
                      </button>
                    </div>
                  </div>
                  
                  {/* TABS */}
                  <div className="flex gap-2 mt-4 overflow-x-auto pb-2">
                    {['dashboard', 'invoices', 'carnet', 'credits', 'products'].map(tab => (
                      <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap text-sm transition-all ${activeTab === tab ? 'tab-active' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        {tab === 'dashboard' ? 'üìä Dashboard' : 
                         tab === 'invoices' ? 'üßæ Fatture' : 
                         tab === 'carnet' ? 'üí≥ Carnet' : 
                         tab === 'credits' ? '‚Ü©Ô∏è Note Credito' : 'üì¶ Prodotti'}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
              
              <div className="max-w-7xl mx-auto px-4 py-6">
                
                {/* ==================== DASHBOARD ==================== */}
                {activeTab === 'dashboard' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-4">
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <h2 className="text-xl font-bold">Analisi Margini per Prodotto</h2>
                        <div className="flex gap-3">
                          <select value={selectedYear} onChange={e => setSelectedYear(e.target.value)} className="px-4 py-2 border rounded-lg">
                            <option value="all">Tutti gli anni</option>
                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                          </select>
                          <input
                            type="text"
                            placeholder="Cerca prodotto..."
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                            className="px-4 py-2 border rounded-lg"
                          />
                        </div>
                      </div>
                    </div>
                    
                    {/* STATISTICHE */}
                    {(() => {
                      const activeProducts = Object.entries(analysis).filter(([, d]) => d.totalQty > 0);
                      const totalCost = activeProducts.reduce((s, [, d]) => s + d.totalCost, 0);
                      const totalRevenue = activeProducts.reduce((s, [, d]) => s + d.onlinePrice * d.totalQty, 0);
                      const avgMargin = totalRevenue > 0 ? ((totalRevenue - totalCost) / totalRevenue) * 100 : 0;
                      const totalQty = activeProducts.reduce((s, [, d]) => s + d.totalQty, 0);
                      
                      return (
                        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                          <div className="bg-white rounded-lg shadow p-4 border-l-4 border-orange-500">
                            <div className="text-sm text-gray-600">Totale Speso</div>
                            <div className="text-2xl font-bold text-orange-600">‚Ç¨ {totalCost.toFixed(2)}</div>
                          </div>
                          <div className="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
                            <div className="text-sm text-gray-600">Incasso Potenziale</div>
                            <div className="text-2xl font-bold text-blue-600">‚Ç¨ {totalRevenue.toFixed(2)}</div>
                          </div>
                          <div className={`bg-white rounded-lg shadow p-4 border-l-4 ${avgMargin < 20 ? 'border-red-500' : avgMargin < 30 ? 'border-yellow-500' : 'border-green-500'}`}>
                            <div className="text-sm text-gray-600">Margine Medio</div>
                            <div className={`text-2xl font-bold ${avgMargin < 20 ? 'text-red-600' : avgMargin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                              {avgMargin.toFixed(1)}%
                            </div>
                          </div>
                          <div className="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                            <div className="text-sm text-gray-600">Confezioni Totali</div>
                            <div className="text-2xl font-bold text-purple-600">{totalQty}</div>
                          </div>
                        </div>
                      );
                    })()}
                    
                    {/* TABELLA */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Prodotto</th>
                            <th className="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Costo Reale</th>
                            <th className="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Prezzo Online</th>
                            <th className="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Margine</th>
                            <th className="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Qt√†</th>
                            <th className="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Status</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {Object.entries(analysis)
                            .filter(([, d]) => d.totalQty > 0)
                            .filter(([product]) => product.toLowerCase().includes(searchQuery.toLowerCase()))
                            .sort(([, a], [, b]) => a.margin - b.margin)
                            .map(([product, data]) => (
                              <tr key={product} className="hover:bg-gray-50">
                                <td className="px-4 py-3">
                                  <span className="font-medium">{product}</span>
                                  {data.hasCarnet && <span className="ml-2 text-xs carnet-badge px-2 py-0.5 rounded">CARNET</span>}
                                </td>
                                <td className="px-4 py-3">‚Ç¨ {data.avgCost.toFixed(2)}</td>
                                <td className="px-4 py-3 font-medium text-blue-600">‚Ç¨ {data.onlinePrice.toFixed(2)}</td>
                                <td className="px-4 py-3">
                                  <span className={`font-bold ${data.margin < 20 ? 'text-red-600' : data.margin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                                    {data.margin.toFixed(1)}%
                                  </span>
                                </td>
                                <td className="px-4 py-3">{data.totalQty}</td>
                                <td className="px-4 py-3">
                                  <span className={`px-2 py-1 rounded text-xs font-bold ${data.margin < 20 ? 'status-bad' : data.margin < 30 ? 'status-ok' : 'status-good'}`}>
                                    {data.margin < 20 ? 'Basso' : data.margin < 30 ? 'Buono' : 'Ottimo'}
                                  </span>
                                </td>
                              </tr>
                            ))}
                        </tbody>
                      </table>
                      {Object.entries(analysis).filter(([, d]) => d.totalQty > 0).length === 0 && (
                        <div className="text-center py-8 text-gray-500">Nessun dato disponibile. Inserisci fatture o carnet.</div>
                      )}
                    </div>
                  </div>
                )}
                
                {/* ==================== FATTURE ==================== */}
                {activeTab === 'invoices' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">{editingInvoice ? 'Modifica Fattura' : 'Nuova Fattura (Acquisti Normali)'}</h2>
                      <p className="text-sm text-gray-500 mb-4">Inserisci qui gli acquisti con "Sconto speciale a voi riservato" (10%)</p>
                      
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Data</label>
                          <input type="date" value={invoiceDate} onChange={e => setInvoiceDate(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Numero Fattura</label>
                          <input type="text" value={invoiceNumber} onChange={e => setInvoiceNumber(e.target.value)} placeholder="es. 253013521" className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                      </div>
                      
                      <div className="overflow-x-auto mb-4">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-100">
                            <tr>
                              <th className="px-3 py-2 text-left">Prodotto</th>
                              <th className="px-3 py-2 text-left">Qt√†</th>
                              <th className="px-3 py-2 text-left">Prezzo Unit. ‚Ç¨</th>
                              <th className="px-3 py-2 text-left">Sconto %</th>
                              <th className="px-3 py-2 text-left">IVA %</th>
                              <th className="px-3 py-2"></th>
                            </tr>
                          </thead>
                          <tbody>
                            {invoiceItems.map((item, i) => (
                              <tr key={i} className="border-b">
                                <td className="px-3 py-2 min-w-[200px]">
                                  <ProductDropdown index={i} value={item.product} onChange={v => updateInvoiceItem(i, 'product', v)} prefix="inv" />
                                </td>
                                <td className="px-3 py-2">
                                  <input type="number" value={item.quantity} onChange={e => updateInvoiceItem(i, 'quantity', e.target.value)} className="w-20 px-2 py-2 border rounded-lg" />
                                </td>
                                <td className="px-3 py-2">
                                  <input type="number" step="0.01" value={item.price} onChange={e => updateInvoiceItem(i, 'price', e.target.value)} className="w-24 px-2 py-2 border rounded-lg" />
                                </td>
                                <td className="px-3 py-2">
                                  <input type="number" value={item.discount} onChange={e => updateInvoiceItem(i, 'discount', e.target.value)} className="w-16 px-2 py-2 border rounded-lg" />
                                </td>
                                <td className="px-3 py-2">
                                  <input type="number" value={item.vat} onChange={e => updateInvoiceItem(i, 'vat', e.target.value)} className="w-16 px-2 py-2 border rounded-lg" />
                                </td>
                                <td className="px-3 py-2">
                                  <button onClick={() => removeInvoiceItem(i)} className="text-red-600 hover:bg-red-50 p-2 rounded">üóëÔ∏è</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                      
                      <div className="flex flex-wrap gap-3">
                        <button onClick={addInvoiceItem} className="px-4 py-2 border-2 border-dashed rounded-lg hover:bg-gray-50">+ Aggiungi riga</button>
                        <button onClick={saveInvoice} disabled={isLoading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                          {editingInvoice ? 'Aggiorna' : 'Salva'} Fattura
                        </button>
                        {editingInvoice && (
                          <button onClick={resetInvoiceForm} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>
                        )}
                      </div>
                    </div>
                    
                    {/* Lista fatture */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Fatture inserite ({invoices.length})</h2>
                      <div className="space-y-3">
                        {invoices.sort((a, b) => b.date.localeCompare(a.date)).map(inv => (
                          <div key={inv.id} className="border rounded-lg p-4 hover:bg-gray-50 flex justify-between items-start">
                            <div>
                              <div className="font-bold">{inv.number} - {inv.date}</div>
                              <div className="text-sm text-gray-600 mt-1">
                                {inv.items.map((it, idx) => (
                                  <div key={idx}>‚Ä¢ {it.product}: {it.quantity} pz @ ‚Ç¨{it.priceGross} (-{it.discount}%)</div>
                                ))}
                              </div>
                            </div>
                            <div className="flex gap-2">
                              <button onClick={() => startEditInvoice(inv)} className="text-blue-600 hover:bg-blue-50 p-2 rounded">‚úèÔ∏è</button>
                              <button onClick={() => deleteInvoice(inv.id)} className="text-red-600 hover:bg-red-50 p-2 rounded">üóëÔ∏è</button>
                            </div>
                          </div>
                        ))}
                        {invoices.length === 0 && <div className="text-center py-4 text-gray-500">Nessuna fattura inserita</div>}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* ==================== CARNET ==================== */}
                {activeTab === 'carnet' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">{editingCarnet ? 'Modifica Carnet' : 'Nuovo Carnet (PURCHASE BANK)'}</h2>
                      <p className="text-sm text-gray-500 mb-4">Inserisci qui gli acquisti prepagati con prezzi scontati</p>
                      
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Data</label>
                          <input type="date" value={carnetDate} onChange={e => setCarnetDate(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Numero Fattura</label>
                          <input type="text" value={carnetNumber} onChange={e => setCarnetNumber(e.target.value)} placeholder="es. 253013523" className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                      </div>
                      
                      <div className="overflow-x-auto mb-4">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-100">
                            <tr>
                              <th className="px-3 py-2 text-left">Prodotto</th>
                              <th className="px-3 py-2 text-left">Qt√†</th>
                              <th className="px-3 py-2 text-left">Prezzo Unit. ‚Ç¨</th>
                              <th className="px-3 py-2 text-left">IVA %</th>
                              <th className="px-3 py-2 text-left">Totale</th>
                              <th className="px-3 py-2"></th>
                            </tr>
                          </thead>
                          <tbody>
                            {carnetItems.map((item, i) => {
                              const qty = parseFloat(item.quantity) || 0;
                              const price = parseFloat(item.priceUnit) || 0;
                              const vat = parseFloat(item.vat) || 4;
                              const total = qty * price * (1 + vat / 100);
                              return (
                                <tr key={i} className="border-b">
                                  <td className="px-3 py-2 min-w-[200px]">
                                    <ProductDropdown index={i} value={item.product} onChange={v => updateCarnetItem(i, 'product', v)} prefix="car" />
                                  </td>
                                  <td className="px-3 py-2">
                                    <input type="number" value={item.quantity} onChange={e => updateCarnetItem(i, 'quantity', e.target.value)} className="w-20 px-2 py-2 border rounded-lg" />
                                  </td>
                                  <td className="px-3 py-2">
                                    <input type="number" step="0.01" value={item.priceUnit} onChange={e => updateCarnetItem(i, 'priceUnit', e.target.value)} className="w-24 px-2 py-2 border rounded-lg" />
                                  </td>
                                  <td className="px-3 py-2">
                                    <input type="number" value={item.vat} onChange={e => updateCarnetItem(i, 'vat', e.target.value)} className="w-16 px-2 py-2 border rounded-lg" />
                                  </td>
                                  <td className="px-3 py-2 font-medium">‚Ç¨ {total.toFixed(2)}</td>
                                  <td className="px-3 py-2">
                                    <button onClick={() => removeCarnetItem(i)} className="text-red-600 hover:bg-red-50 p-2 rounded">üóëÔ∏è</button>
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                      
                      <div className="flex flex-wrap gap-3">
                        <button onClick={addCarnetItem} className="px-4 py-2 border-2 border-dashed rounded-lg hover:bg-gray-50">+ Aggiungi riga</button>
                        <button onClick={saveCarnet} disabled={isLoading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                          {editingCarnet ? 'Aggiorna' : 'Salva'} Carnet
                        </button>
                        {editingCarnet && (
                          <button onClick={resetCarnetForm} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>
                        )}
                      </div>
                    </div>
                    
                    {/* Lista carnet */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Carnet inseriti ({carnet.length})</h2>
                      <div className="space-y-3">
                        {carnet.sort((a, b) => b.date.localeCompare(a.date)).map(c => {
                          const total = c.items.reduce((s, it) => s + (it.total || 0), 0);
                          return (
                            <div key={c.id} className="border rounded-lg p-4 hover:bg-gray-50 flex justify-between items-start border-l-4 border-blue-500">
                              <div>
                                <div className="font-bold flex items-center gap-2">
                                  {c.number} - {c.date}
                                  <span className="text-xs carnet-badge px-2 py-0.5 rounded">CARNET</span>
                                </div>
                                <div className="text-sm text-gray-600 mt-1">
                                  {c.items.map((it, idx) => (
                                    <div key={idx}>‚Ä¢ {it.product}: {it.quantity} pz @ ‚Ç¨{it.priceUnit}</div>
                                  ))}
                                </div>
                                <div className="font-medium mt-2 text-blue-600">Totale: ‚Ç¨ {total.toFixed(2)}</div>
                              </div>
                              <div className="flex gap-2">
                                <button onClick={() => startEditCarnet(c)} className="text-blue-600 hover:bg-blue-50 p-2 rounded">‚úèÔ∏è</button>
                                <button onClick={() => deleteCarnet(c.id)} className="text-red-600 hover:bg-red-50 p-2 rounded">üóëÔ∏è</button>
                              </div>
                            </div>
                          );
                        })}
                        {carnet.length === 0 && <div className="text-center py-4 text-gray-500">Nessun carnet inserito</div>}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* ==================== NOTE CREDITO ==================== */}
                {activeTab === 'credits' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">{editingCredit ? 'Modifica Nota Credito' : 'Nuova Nota di Credito (Reso)'}</h2>
                      
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Data</label>
                          <input type="date" value={creditDate} onChange={e => setCreditDate(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Prodotto</label>
                          <select value={creditProduct} onChange={e => setCreditProduct(e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            {PRODUCTS.map(p => <option key={p} value={p}>{p}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Quantit√†</label>
                          <input type="number" value={creditQuantity} onChange={e => setCreditQuantity(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Prezzo Unitario ‚Ç¨</label>
                          <input type="number" step="0.01" value={creditPriceUnit} onChange={e => setCreditPriceUnit(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">IVA %</label>
                          <input type="number" value={creditVat} onChange={e => setCreditVat(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Totale</label>
                          <div className="px-3 py-2 bg-gray-100 rounded-lg font-medium">
                            ‚Ç¨ {((parseFloat(creditQuantity) || 0) * (parseFloat(creditPriceUnit) || 0) * (1 + (parseFloat(creditVat) || 4) / 100)).toFixed(2)}
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex flex-wrap gap-3">
                        <button onClick={saveCreditNote} disabled={isLoading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                          {editingCredit ? 'Aggiorna' : 'Salva'} Nota Credito
                        </button>
                        {editingCredit && (
                          <button onClick={resetCreditForm} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>
                        )}
                      </div>
                    </div>
                    
                    {/* Lista note credito */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Note di Credito ({creditNotes.length})</h2>
                      <div className="space-y-3">
                        {creditNotes.sort((a, b) => b.date.localeCompare(a.date)).map(note => (
                          <div key={note.id} className="border rounded-lg p-4 hover:bg-gray-50 flex justify-between items-center border-l-4 border-red-500">
                            <div>
                              <div className="font-bold">{note.date} - {note.product}</div>
                              <div className="text-sm text-gray-600">{note.quantity} pz @ ‚Ç¨{note.priceUnit} = <span className="font-medium text-red-600">-‚Ç¨ {note.total?.toFixed(2)}</span></div>
                            </div>
                            <div className="flex gap-2">
                              <button onClick={() => startEditCredit(note)} className="text-blue-600 hover:bg-blue-50 p-2 rounded">‚úèÔ∏è</button>
                              <button onClick={() => deleteCreditNote(note.id)} className="text-red-600 hover:bg-red-50 p-2 rounded">üóëÔ∏è</button>
                            </div>
                          </div>
                        ))}
                        {creditNotes.length === 0 && <div className="text-center py-4 text-gray-500">Nessuna nota di credito</div>}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* ==================== PRODOTTI ==================== */}
                {activeTab === 'products' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">{editingProduct ? 'Modifica Prodotto' : 'Nuovo Prodotto'}</h2>
                      
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Nome Prodotto</label>
                          <input type="text" value={newProductName} onChange={e => setNewProductName(e.target.value)} placeholder="es. BIOFINITY 3PK" className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Prezzo Online ‚Ç¨</label>
                          <input type="number" step="0.01" value={newProductPrice} onChange={e => setNewProductPrice(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Disponibile in Carnet?</label>
                          <label className="flex items-center gap-2 mt-2">
                            <input type="checkbox" checked={newProductCarnet} onChange={e => setNewProductCarnet(e.target.checked)} className="w-5 h-5" />
                            <span>S√¨, questo prodotto ha opzione carnet</span>
                          </label>
                        </div>
                      </div>
                      
                      <div className="flex flex-wrap gap-3">
                        <button 
                          onClick={async () => {
                            if (!newProductName) return setModal({ show: true, type: 'warning', title: 'Nome richiesto', message: 'Inserisci il nome del prodotto.' });
                            const action = editingProduct ? 'updateProduct' : 'addProduct';
                            const payload = editingProduct 
                              ? { oldName: editingProduct, newName: newProductName, onlinePrice: parseFloat(newProductPrice) || 0, hasCarnet: newProductCarnet }
                              : { name: newProductName, onlinePrice: parseFloat(newProductPrice) || 0, hasCarnet: newProductCarnet };
                            const success = await saveToGoogleSheets(action, payload);
                            if (success) {
                              setEditingProduct(null);
                              setNewProductName('');
                              setNewProductPrice('');
                              setNewProductCarnet(false);
                              setModal({ show: true, type: 'success', title: 'Salvato', message: 'Prodotto salvato!' });
                            }
                          }} 
                          disabled={isLoading} 
                          className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                          {editingProduct ? 'Aggiorna' : 'Aggiungi'} Prodotto
                        </button>
                        {editingProduct && (
                          <button onClick={() => { setEditingProduct(null); setNewProductName(''); setNewProductPrice(''); setNewProductCarnet(false); }} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            Annulla
                          </button>
                        )}
                      </div>
                    </div>
                    
                    {/* Lista prodotti */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">Prodotti ({PRODUCTS.length})</h2>
                        <input
                          type="text"
                          placeholder="Cerca..."
                          value={productListSearch}
                          onChange={e => setProductListSearch(e.target.value)}
                          className="px-3 py-2 border rounded-lg"
                        />
                      </div>
                      <div className="space-y-2">
                        {PRODUCTS.filter(p => p.toLowerCase().includes(productListSearch.toLowerCase())).map(product => (
                          <div key={product} className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                            <div className="flex-1">
                              <div className="font-medium flex items-center gap-2">
                                {product}
                                {products[product]?.hasCarnet && <span className="text-xs carnet-badge px-2 py-0.5 rounded">CARNET</span>}
                              </div>
                              <div className="text-sm text-gray-600">Prezzo online: ‚Ç¨ {products[product]?.onlinePrice?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => {
                                  setEditingProduct(product);
                                  setNewProductName(product);
                                  setNewProductPrice(products[product]?.onlinePrice || '');
                                  setNewProductCarnet(products[product]?.hasCarnet || false);
                                  window.scrollTo({ top: 0, behavior: 'smooth' });
                                }}
                                className="text-blue-600 hover:bg-blue-50 p-2 rounded"
                              >‚úèÔ∏è</button>
                              <button
                                onClick={() => {
                                  const inUse = invoices.some(inv => inv.items.some(it => it.product === product)) ||
                                               carnet.some(c => c.items.some(it => it.product === product)) ||
                                               creditNotes.some(n => n.product === product);
                                  if (inUse) {
                                    return setModal({ show: true, type: 'warning', title: 'Prodotto in uso', message: 'Non puoi eliminare un prodotto presente in fatture, carnet o note credito.' });
                                  }
                                  setConfirmModal({
                                    show: true, title: 'Elimina prodotto', message: `Eliminare "${product}"?`,
                                    onConfirm: async () => {
                                      setConfirmModal({ show: false });
                                      await saveToGoogleSheets('deleteProduct', { name: product });
                                    }
                                  });
                                }}
                                className="text-red-600 hover:bg-red-50 p-2 rounded"
                              >üóëÔ∏è</button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              {/* MODALI */}
              {modal.show && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg p-6 max-w-md w-full">
                    <div className="flex items-start gap-3 mb-4">
                      <span className="text-2xl">{modal.type === 'error' ? '‚ùå' : modal.type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                      <div>
                        <h3 className="text-lg font-bold">{modal.title}</h3>
                        <p className="text-gray-600">{modal.message}</p>
                      </div>
                    </div>
                    <button onClick={() => setModal({ show: false })} className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">OK</button>
                  </div>
                </div>
              )}
              
              {confirmModal.show && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 className="text-lg font-bold mb-2">{confirmModal.title}</h3>
                    <p className="text-gray-600 mb-4">{confirmModal.message}</p>
                    <div className="flex gap-3">
                      <button onClick={() => setConfirmModal({ show: false })} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>
                      <button onClick={confirmModal.onConfirm} className="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Elimina</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
